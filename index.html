<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMEBE - Dashboard de Proyectos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-500 to-orange-700">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96 fade-in">
            <div class="text-center mb-6">
                <div class="mx-auto mb-4 h-20 w-20 bg-orange-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-3xl font-bold">EB</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">EMEBE</h1>
                <p class="text-gray-600 mt-2">Dashboard de Proyectos</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="passwordInput" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        placeholder="Ingrese la contrase√±a"
                        required
                    >
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition duration-200"
                >
                    Acceder
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden">Contrase√±a incorrecta</p>
            </form>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="h-12 w-12 bg-orange-600 rounded flex items-center justify-center">
                            <span class="text-white text-xl font-bold">EB</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">EMEBE</h1>
                            <p class="text-sm text-gray-600">Control de Proyectos</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="projectSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Cargando proyectos...</option>
                        </select>
                        <button onclick="logout()" class="text-orange-600 hover:text-orange-800 font-medium">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="container mx-auto px-6 py-8">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="flex flex-col justify-center items-center py-20">
                <div class="loader"></div>
                <p class="mt-4 text-gray-600">Cargando datos del proyecto...</p>
                <p id="loadingStatus" class="mt-2 text-sm text-gray-500"></p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-50 border-2 border-red-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-red-800 mb-2">‚ùå Error de Conexi√≥n</h3>
                <p class="text-red-700 mb-4" id="errorText"></p>
                <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                    Reintentar
                </button>
            </div>

            <!-- Contenido del Dashboard -->
            <div id="dashboardContent" class="hidden space-y-6">
                <!-- Resumen del Proyecto -->
                <div class="bg-white rounded-lg shadow-md p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4" id="projectTitle">Proyecto</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Cliente</p>
                            <p class="text-xl font-bold text-gray-800" id="clientName">-</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Progreso Global</p>
                            <p class="text-xl font-bold text-blue-600" id="globalProgress">0%</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Fecha Inicio</p>
                            <p class="text-xl font-bold text-gray-800" id="startDate">-</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Fecha Fin</p>
                            <p class="text-xl font-bold text-gray-800" id="endDate">-</p>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Fases -->
                <div class="bg-white rounded-lg shadow-md p-6 fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Progreso por Fase</h3>
                    <canvas id="phasesChart" height="80"></canvas>
                </div>

                <!-- KPIs por Departamento -->
                <div class="bg-white rounded-lg shadow-md p-6 fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Tareas por Departamento</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="departmentKPIs">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Tabla EDT -->
                <div class="bg-white rounded-lg shadow-md p-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Estructura EDT</h3>
                        <input 
                            type="text" 
                            id="edtSearch" 
                            placeholder="Buscar por c√≥digo EDT o nombre..."
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 w-64"
                        >
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo EDT</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tarea</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fase</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Departamento</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Responsable</th>
                                </tr>
                            </thead>
                            <tbody id="edtTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuraci√≥n
        const CONFIG = {
            BASEROW_API_URL: 'https://api.baserow.io/api/database/rows/table/',
            API_TOKEN: 'RXnsEyGpnHUsNRG65eCxehblqtTTbOtd',
            PASSWORD: 'emebe2026',
            TABLES: {
                EDT: '828214',
                PANEL: '829039',
                FASES: '829032'
            }
        };

        // Variables globales
        let currentProjectId = null;
        let allProjects = [];
        let edtData = [];
        let phasesData = [];
        let panelData = [];
        let phasesChart = null;

        // Funci√≥n para actualizar estado de carga
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('Status:', message);
        }

        // Funci√≥n para mostrar error
        function showError(message, details) {
            console.error('Error:', message, details);
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            
            if (password === CONFIG.PASSWORD) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadProjects();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        });

        // Logout
        function logout() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        // Cargar proyectos disponibles
        async function loadProjects() {
            updateLoadingStatus('Conectando a Baserow...');
            
            try {
                const url = `${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.EDT}/?user_field_names=true&size=100`;
                
                updateLoadingStatus('Obteniendo lista de proyectos...');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${CONFIG.API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                updateLoadingStatus(`Procesando ${data.results.length} registros...`);
                
                // Extraer proyectos √∫nicos
                const projectsMap = new Map();
                data.results.forEach(row => {
                    if (row.proyecto_id && row.proyecto_nombre) {
                        projectsMap.set(row.proyecto_id, row.proyecto_nombre);
                    }
                });
                
                allProjects = Array.from(projectsMap, ([id, name]) => ({ id, name }));
                
                updateLoadingStatus(`${allProjects.length} proyectos encontrados`);
                
                // Llenar selector
                const selector = document.getElementById('projectSelector');
                selector.innerHTML = '<option value="">Seleccione un proyecto</option>';
                
                allProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    selector.appendChild(option);
                });
                
                // Seleccionar proyecto por defecto
                if (allProjects.length > 0) {
                    const defaultProject = allProjects[0];
                    selector.value = defaultProject.id;
                    loadProjectData(defaultProject.id);
                }
                
            } catch (error) {
                showError(
                    'No se pudo conectar a Baserow. Verifica tu conexi√≥n a internet y que el token API sea v√°lido.',
                    error
                );
            }
        }

        // Cambio de proyecto
        document.addEventListener('DOMContentLoaded', function() {
            const selector = document.getElementById('projectSelector');
            if (selector) {
                selector.addEventListener('change', function(e) {
                    const projectId = e.target.value;
                    if (projectId) {
                        loadProjectData(projectId);
                    }
                });
            }
        });

        // Cargar datos del proyecto
        async function loadProjectData(projectId) {
            currentProjectId = projectId;
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            
            try {
                updateLoadingStatus('Cargando datos EDT...');
                
                // Cargar datos de las 3 tablas en paralelo
                const [edtResponse, panelResponse, phasesResponse] = await Promise.all([
                    fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.EDT}/?user_field_names=true&size=1000`, {
                        headers: {
                            'Authorization': `Token ${CONFIG.API_TOKEN}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.PANEL}/?user_field_names=true&size=1000`, {
                        headers: {
                            'Authorization': `Token ${CONFIG.API_TOKEN}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.FASES}/?user_field_names=true&size=1000`, {
                        headers: {
                            'Authorization': `Token ${CONFIG.API_TOKEN}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);
                
                if (!edtResponse.ok || !panelResponse.ok || !phasesResponse.ok) {
                    throw new Error('Error al cargar datos de Baserow');
                }
                
                updateLoadingStatus('Procesando datos...');
                
                const edtDataAll = await edtResponse.json();
                const panelDataAll = await panelResponse.json();
                const phasesDataAll = await phasesResponse.json();
                
                // Filtrar por proyecto actual
                edtData = edtDataAll.results.filter(row => row.proyecto_id === projectId);
                panelData = panelDataAll.results.filter(row => row.proyecto_id === projectId);
                phasesData = phasesDataAll.results.filter(row => row.proyecto_id === projectId);
                
                console.log('Datos cargados:', {
                    edt: edtData.length,
                    panel: panelData.length,
                    fases: phasesData.length
                });
                
                updateLoadingStatus('Renderizando dashboard...');
                
                // Renderizar dashboard
                renderDashboard();
                
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                
            } catch (error) {
                showError('Error al cargar los datos del proyecto', error);
            }
        }

        // Renderizar dashboard
        function renderDashboard() {
            renderProjectSummary();
            renderPhasesChart();
            renderDepartmentKPIs();
            renderEDTTable();
        }

        // Resumen del proyecto
        function renderProjectSummary() {
            const projectName = allProjects.find(p => p.id === currentProjectId)?.name || 'Proyecto';
            document.getElementById('projectTitle').textContent = projectName;
            
            const panelInfo = panelData[0] || {};
            document.getElementById('clientName').textContent = panelInfo.CLIENTE || '-';
            document.getElementById('globalProgress').textContent = `${panelInfo.Progreso_global || 0}%`;
            document.getElementById('startDate').textContent = panelInfo.fecha_inicio || '-';
            document.getElementById('endDate').textContent = panelInfo.fecha_fin || '-';
        }

        // Gr√°fico de fases
        function renderPhasesChart() {
            const sortedPhases = phasesData.sort((a, b) => a.numero_fase - b.numero_fase);
            
            const labels = sortedPhases.map(p => p.nombre_fase);
            const progressData = sortedPhases.map(p => p.progreso || 0);
            const totals = sortedPhases.map(p => p.tareas_totales || 0);
            const completed = sortedPhases.map(p => p.tareas_completadas || 0);
            
            const backgroundColors = progressData.map(progress => {
                if (progress >= 70) return 'rgba(34, 197, 94, 0.8)';
                if (progress >= 30) return 'rgba(251, 191, 36, 0.8)';
                return 'rgba(239, 68, 68, 0.8)';
            });
            
            const ctx = document.getElementById('phasesChart');
            
            if (phasesChart) {
                phasesChart.destroy();
            }
            
            phasesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Progreso (%)',
                        data: progressData,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        `Progreso: ${progressData[index]}%`,
                                        `Completadas: ${completed[index]}/${totals[index]}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // KPIs por departamento
        function renderDepartmentKPIs() {
            const departments = {};
            
            edtData.forEach(row => {
                const dept = row.departamento || 'Sin Departamento';
                if (!departments[dept]) {
                    departments[dept] = { total: 0, completadas: 0, pendientes: 0 };
                }
                departments[dept].total++;
                if (row.completado) {
                    departments[dept].completadas++;
                } else {
                    departments[dept].pendientes++;
                }
            });
            
            const container = document.getElementById('departmentKPIs');
            container.innerHTML = '';
            
            const icons = {
                'PM': 'üìã',
                'Mecanico': '‚öôÔ∏è',
                'Electrico': '‚ö°',
                'PLC': 'üñ•Ô∏è',
                'Comun': 'üìÅ'
            };
            
            Object.entries(departments).forEach(([dept, stats]) => {
                const icon = icons[dept] || 'üìå';
                const progress = stats.total > 0 ? Math.round((stats.completadas / stats.total) * 100) : 0;
                
                const card = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-2xl">${icon}</span>
                            <span class="text-sm font-semibold text-gray-600">${progress}%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-800">${dept}</p>
                        <p class="text-xs text-gray-600">${stats.completadas}/${stats.total} tareas</p>
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-orange-600 h-2 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // Tabla EDT
        function renderEDTTable(filter = '') {
            const tbody = document.getElementById('edtTableBody');
            tbody.innerHTML = '';
            
            let filteredData = edtData;
            if (filter) {
                filteredData = edtData.filter(row => 
                    (row.codigo_edt && row.codigo_edt.toLowerCase().includes(filter.toLowerCase())) ||
                    (row.nombre_tarea && row.nombre_tarea.toLowerCase().includes(filter.toLowerCase()))
                );
            }
            
            filteredData.sort((a, b) => {
                const codeA = a.codigo_edt || '';
                const codeB = b.codigo_edt || '';
                return codeA.localeCompare(codeB, undefined, { numeric: true });
            });
            
            filteredData.forEach(row => {
                const nivel = row.nivel || 0;
                const indent = '&nbsp;'.repeat(nivel * 4);
                
                const estadoColor = {
                    'Completado': 'bg-green-100 text-green-800',
                    'En Curso': 'bg-blue-100 text-blue-800',
                    'Pendiente': 'bg-yellow-100 text-yellow-800',
                    'Bloqueado': 'bg-red-100 text-red-800'
                };
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-mono">${row.codigo_edt || '-'}</td>
                    <td class="px-4 py-3 text-sm">${indent}${row.nombre_tarea || '-'}</td>
                    <td class="px-4 py-3 text-sm">${row.fase || '-'}</td>
                    <td class="px-4 py-3 text-sm">${row.departamento || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoColor[row.estado] || 'bg-gray-100 text-gray-800'}">
                            ${row.estado || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${row.responsable || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // B√∫squeda en tabla EDT
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('edtSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    renderEDTTable(e.target.value);
                });
            }
        });
    </script>
</body>
</html>