<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMEBE - Dashboard Ejecutivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 1s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-600 via-orange-500 to-orange-700">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-96 fade-in">
            <div class="text-center mb-8">
                <div class="mx-auto mb-6 h-24 w-24 bg-gradient-to-br from-orange-600 to-orange-700 rounded-xl flex items-center justify-center shadow-lg">
                    <span class="text-white text-4xl font-bold">EB</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">EMEBE</h1>
                <p class="text-gray-600 mt-2">Dashboard Ejecutivo</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="passwordInput" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition"
                        placeholder="Ingrese la contrase√±a"
                        required
                    >
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-md"
                >
                    Acceder al Dashboard
                </button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden mt-2">Contrase√±a incorrecta</p>
            </form>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="h-12 w-12 bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg flex items-center justify-center shadow-md">
                            <span class="text-white text-xl font-bold">EB</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">EMEBE</h1>
                            <p class="text-xs text-gray-600">Dashboard Ejecutivo</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="projectSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 text-sm">
                            <option value="">Cargando proyectos...</option>
                        </select>
                        <button onclick="logout()" class="text-orange-600 hover:text-orange-800 font-medium text-sm transition">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading -->
        <div id="loadingSpinner" class="flex flex-col justify-center items-center py-32">
            <div class="loader"></div>
            <p class="mt-6 text-gray-600 font-medium">Cargando datos del proyecto...</p>
        </div>

        <!-- Contenido Principal -->
        <main id="dashboardContent" class="hidden max-w-7xl mx-auto px-6 py-8 space-y-6">
            <!-- Info del Proyecto -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="flex items-start space-x-3 mb-4">
                            <div class="flex-shrink-0 mt-1">
                                <div class="h-10 w-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <span class="text-orange-600 text-xl">üìã</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Proyecto</p>
                                <h2 class="text-2xl font-bold text-gray-900" id="projectName">-</h2>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <div>
                                <p class="text-xs text-gray-500 uppercase mb-1">N¬∫ Proyecto</p>
                                <p class="text-sm font-semibold text-gray-900" id="projectNumber">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase mb-1">Cliente</p>
                                <p class="text-sm font-semibold text-gray-900" id="clientName">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase mb-1">Lugar</p>
                                <p class="text-sm font-semibold text-gray-900" id="lugar">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase mb-1">L√≠nea</p>
                                <p class="text-sm font-semibold text-gray-900" id="linea">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <p class="text-xs text-gray-500 uppercase mb-1">Resp. Cliente</p>
                            <p class="text-sm font-semibold text-gray-900" id="respCliente">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase mb-1">PM</p>
                            <p class="text-sm font-semibold text-gray-900" id="pmName">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase mb-1">Fecha Inicio</p>
                            <p class="text-sm font-semibold text-gray-900" id="fechaInicio">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progreso Global -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl shadow-sm border border-blue-200 p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <p class="text-sm text-blue-700 font-medium uppercase tracking-wide mb-1">Progreso Global del Proyecto</p>
                        <h3 class="text-5xl font-bold text-blue-900" id="progresoGlobal">0%</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-blue-700 mb-1">Tareas Completadas</p>
                        <p class="text-2xl font-bold text-blue-900" id="tareasStats">0/0</p>
                    </div>
                </div>
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div class="text-xs font-semibold text-blue-700">0%</div>
                        <div class="text-xs font-semibold text-blue-700">100%</div>
                    </div>
                    <div class="overflow-hidden h-6 text-xs flex rounded-full bg-blue-200">
                        <div id="progresoBar" class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-blue-700" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Progreso por Fases -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 fade-in">
                <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center">
                    <span class="text-2xl mr-3">üìä</span>
                    Progreso por Fase
                </h3>
                <div class="space-y-4" id="fasesContainer">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Horas: Ofertadas vs Reales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 fade-in">
                    <h3 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                        <span class="text-lg mr-2">‚è±Ô∏è</span>
                        Horas Mec√°nicas
                    </h3>
                    <canvas id="horasMecanicasChart" height="80"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 fade-in">
                    <h3 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                        <span class="text-lg mr-2">‚ö°</span>
                        Horas El√©ctricas
                    </h3>
                    <canvas id="horasElectricasChart" height="80"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 fade-in">
                    <h3 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                        <span class="text-lg mr-2">üìä</span>
                        Horas Totales
                    </h3>
                    <canvas id="horasTotalesChart" height="80"></canvas>
                </div>
            </div>

            <!-- Costes: Ofertados vs Reales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 fade-in">
                    <h3 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                        <span class="text-lg mr-2">üí∞</span>
                        Costes Mec√°nicos
                    </h3>
                    <canvas id="costesMecanicosChart" height="80"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 fade-in">
                    <h3 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                        <span class="text-lg mr-2">üíµ</span>
                        Costes El√©ctricos
                    </h3>
                    <canvas id="costesElectricosChart" height="80"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 fade-in">
                    <h3 class="text-sm font-bold text-gray-900 mb-2 flex items-center">
                        <span class="text-lg mr-2">üí∏</span>
                        Costes Totales
                    </h3>
                    <canvas id="costesTotalesChart" height="80"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CONFIG = {
            BASEROW_API_URL: 'https://api.baserow.io/api/database/rows/table/',
            API_TOKEN: 'M0RUOaj1np4dwXDsm9s5OMcVZ1GXUugN',
            PASSWORD: 'emebe2026',
            TABLES: {
                EDT: '828214',
                PANEL: '829039',
                FASES: '829032'
            }
        };

        let currentProjectId = null;
        let allProjects = [];
        let edtData = [];
        let panelData = [];
        let charts = {};

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            
            if (password === CONFIG.PASSWORD) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadProjects();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        });

        function logout() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        async function loadProjects() {
            try {
                const response = await fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.EDT}/?user_field_names=true&size=200`, {
                    headers: { 'Authorization': `Token ${CONFIG.API_TOKEN}` }
                });
                
                const data = await response.json();
                
                const projectsMap = new Map();
                data.results.forEach(row => {
                    const projId = row.proyecto_id || row.clickup_task_id;
                    const projName = row.proyecto_nombre || row.nombre_tarea;
                    if (projId && projName) {
                        projectsMap.set(projId, projName);
                    }
                });
                
                allProjects = Array.from(projectsMap, ([id, name]) => ({ id, name }));
                
                const selector = document.getElementById('projectSelector');
                selector.innerHTML = '<option value="">Seleccione un proyecto</option>';
                
                allProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    selector.appendChild(option);
                });
                
                const project2520 = allProjects.find(p => p.name.includes('2520'));
                if (project2520) {
                    selector.value = project2520.id;
                    loadProjectData(project2520.id);
                }
                
            } catch (error) {
                console.error('Error cargando proyectos:', error);
            }
        }

        document.getElementById('projectSelector')?.addEventListener('change', function(e) {
            if (e.target.value) loadProjectData(e.target.value);
        });

        async function loadProjectData(projectId) {
            currentProjectId = projectId;
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            
            try {
                const [edtResponse, panelResponse] = await Promise.all([
                    fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.EDT}/?user_field_names=true&size=200`, {
                        headers: { 'Authorization': `Token ${CONFIG.API_TOKEN}` }
                    }),
                    fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.TABLES.PANEL}/?user_field_names=true&size=200`, {
                        headers: { 'Authorization': `Token ${CONFIG.API_TOKEN}` }
                    })
                ]);
                
                const edtDataAll = await edtResponse.json();
                const panelDataAll = await panelResponse.json();
                
                edtData = edtDataAll.results.filter(row => 
                    row.proyecto_id === projectId || row.clickup_task_id === projectId
                );
                panelData = panelDataAll.results.filter(row => 
                    row.proyecto_id === projectId || row.clickup_task_id === projectId
                );
                
                renderDashboard();
                
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderDashboard() {
            renderProjectInfo();
            renderProgresoGlobal();
            renderProgresoFases();
            renderHorasCharts();
            renderCostesCharts();
        }

        function renderProjectInfo() {
            const panel = panelData[0] || {};
            const projectName = allProjects.find(p => p.id === currentProjectId)?.name || '-';
            
            document.getElementById('projectName').textContent = projectName;
            document.getElementById('projectNumber').textContent = panel['N¬∫_PROYECTO'] || panel.numero_proyecto || '-';
            document.getElementById('clientName').textContent = panel.CLIENTE || '-';
            document.getElementById('lugar').textContent = panel.lugar || '-';
            document.getElementById('linea').textContent = panel.linea || '-';
            document.getElementById('respCliente').textContent = panel.responsable_cliente || '-';
            document.getElementById('pmName').textContent = panel.PM || '-';
            
            const fechaInicio = panel.fecha_inicio;
            if (fechaInicio) {
                const date = new Date(fechaInicio);
                document.getElementById('fechaInicio').textContent = date.toLocaleDateString('es-ES');
            }
        }

        function renderProgresoGlobal() {
            // Excluir tareas anuladas del c√≥mputo
            const tareasActivas = edtData.filter(t => {
                const estado = t.estado || '';
                return estado !== 'Anulado';
            });
            
            const total = tareasActivas.length;
            const completadas = tareasActivas.filter(t => {
                const estado = t.estado || '';
                return estado === 'Completado';
            }).length;
            
            const progreso = total > 0 ? Math.round((completadas / total) * 100) : 0;
            
            document.getElementById('progresoGlobal').textContent = progreso + '%';
            document.getElementById('tareasStats').textContent = `${completadas}/${total}`;
            document.getElementById('progresoBar').style.width = progreso + '%';
        }

        function renderProgresoFases() {
            const fases = [
                { num: 1, nombre: 'Inicio', icon: 'üöÄ' },
                { num: 2, nombre: 'Dise√±o', icon: 'üìê' },
                { num: 3, nombre: 'Compras', icon: 'üõí' },
                { num: 4, nombre: 'Fabricaci√≥n', icon: 'üè≠' },
                { num: 5, nombre: 'Montaje', icon: 'üîß' },
                { num: 6, nombre: 'Programaci√≥n', icon: 'üíª' },
                { num: 7, nombre: 'Pruebas y Aceptaci√≥n', icon: '‚úÖ' },
                { num: 8, nombre: 'Cierre', icon: 'üéØ' }
            ];
            
            const container = document.getElementById('fasesContainer');
            container.innerHTML = '';
            
            fases.forEach(fase => {
                // Filtrar tareas de la fase:
                // - Que empiecen con el n√∫mero de fase (ej: "1.")
                // - Que NO sean la tarea nivel 1 (la fase misma)
                // - Que NO est√©n anuladas
                const tareasf = edtData.filter(t => {
                    const code = t.codigo_edt?.toString() || '';
                    const nivel = parseInt(t.nivel) || 0;
                    const estado = t.estado || '';
                    
                    return code.startsWith(fase.num + '.') && 
                           nivel > 1 && 
                           estado !== 'Anulado';
                });
                
                const total = tareasf.length;
                const completadas = tareasf.filter(t => {
                    const estado = t.estado || '';
                    return estado === 'Completado';
                }).length;
                const progreso = total > 0 ? Math.round((completadas / total) * 100) : 0;
                
                let colorClass = 'bg-red-500';
                if (progreso >= 70) colorClass = 'bg-green-500';
                else if (progreso >= 30) colorClass = 'bg-yellow-500';
                
                const html = `
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 w-32">
                            <span class="text-lg">${fase.icon}</span>
                            <span class="text-sm font-medium text-gray-700 ml-2">${fase.nombre}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs text-gray-500">${completadas}/${total} tareas</span>
                                <span class="text-sm font-bold text-gray-900">${progreso}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="progress-bar ${colorClass} h-3 rounded-full transition-all duration-1000" style="width: ${progreso}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderHorasCharts() {
            const panel = panelData[0] || {};
            
            // Horas Mec√°nicas
            const hmOfertadas = parseFloat(panel.h_mecanicas_ofertadas) || 0;
            const hmReales = parseFloat(panel.h_mecanicas_reales) || 0;
            
            if (charts.horasMecanicas) charts.horasMecanicas.destroy();
            charts.horasMecanicas = new Chart(document.getElementById('horasMecanicasChart'), {
                type: 'bar',
                data: {
                    labels: ['Ofertadas', 'Reales'],
                    datasets: [{
                        data: [hmOfertadas, hmReales],
                        backgroundColor: ['#3b82f6', '#10b981'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + 'h';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v + 'h',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
            
            // Horas El√©ctricas
            const heOfertadas = parseFloat(panel.h_electricas_ofertadas) || 0;
            const heReales = parseFloat(panel.h_electricas_reales) || 0;
            
            if (charts.horasElectricas) charts.horasElectricas.destroy();
            charts.horasElectricas = new Chart(document.getElementById('horasElectricasChart'), {
                type: 'bar',
                data: {
                    labels: ['Ofertadas', 'Reales'],
                    datasets: [{
                        data: [heOfertadas, heReales],
                        backgroundColor: ['#3b82f6', '#10b981'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + 'h';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v + 'h',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
            
            // Horas TOTALES
            const htOfertadas = hmOfertadas + heOfertadas;
            const htReales = hmReales + heReales;
            
            console.log('Horas Totales - Ofertadas:', htOfertadas, 'Reales:', htReales);
            
            if (charts.horasTotales) charts.horasTotales.destroy();
            charts.horasTotales = new Chart(document.getElementById('horasTotalesChart'), {
                type: 'bar',
                data: {
                    labels: ['Ofertadas', 'Reales'],
                    datasets: [{
                        data: [htOfertadas, htReales],
                        backgroundColor: ['#3b82f6', '#10b981'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + 'h';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v + 'h',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderCostesCharts() {
            const panel = panelData[0] || {};
            
            // Costes Mec√°nicos
            const cmOfertado = parseFloat(panel.coste_mecanikco_ofertado || panel.coste_mecanico_ofertado) || 0;
            const cmReal = parseFloat(panel.coste_mecanico_real) || 0;
            
            if (charts.costesMecanicos) charts.costesMecanicos.destroy();
            charts.costesMecanicos = new Chart(document.getElementById('costesMecanicosChart'), {
                type: 'bar',
                data: {
                    labels: ['Ofertado', 'Real'],
                    datasets: [{
                        data: [cmOfertado, cmReal],
                        backgroundColor: ['#f59e0b', '#ef4444'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('es-ES') + '‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v.toLocaleString('es-ES', {maximumFractionDigits: 0}) + '‚Ç¨',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
            
            // Costes El√©ctricos
            const ceOfertado = parseFloat(panel.coste_electrico_ofertado) || 0;
            const ceReal = parseFloat(panel.coste_electrico_real) || 0;
            
            if (charts.costesElectricos) charts.costesElectricos.destroy();
            charts.costesElectricos = new Chart(document.getElementById('costesElectricosChart'), {
                type: 'bar',
                data: {
                    labels: ['Ofertado', 'Real'],
                    datasets: [{
                        data: [ceOfertado, ceReal],
                        backgroundColor: ['#f59e0b', '#ef4444'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('es-ES') + '‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v.toLocaleString('es-ES', {maximumFractionDigits: 0}) + '‚Ç¨',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
            
            // Costes TOTALES
            const ctOfertado = cmOfertado + ceOfertado;
            const ctReal = cmReal + ceReal;
            
            console.log('Costes Totales - Ofertado:', ctOfertado, 'Real:', ctReal);
            
            if (charts.costesTotales) charts.costesTotales.destroy();
            charts.costesTotales = new Chart(document.getElementById('costesTotalesChart'), {
                type: 'bar',
                data: {
                    labels: ['Ofertado', 'Real'],
                    datasets: [{
                        data: [ctOfertado, ctReal],
                        backgroundColor: ['#f59e0b', '#ef4444'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('es-ES') + '‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v.toLocaleString('es-ES', {maximumFractionDigits: 0}) + '‚Ç¨',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>